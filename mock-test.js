const productos = [
  {
    "_id": "6997746669a908ef4233204e",
    "mbData": {
      "creationDate": "2026-02-26T04:34:31.542Z",
      "createdBy": null,
      "creationMethod": null,
      "modDate": "2026-02-26T04:34:31.542Z",
      "modBy": null,
      "modMethod": null
    },
    "customerData": {
      "LoteProducto": "TEST-P03",
      "NombreProducto": "mantequilla",
      "MarcaProducto": "Colun",
      "CategoriaProducto": "Productos Perecederos ",
      "Cantidad": 20,
      "UnidadMedida": "Gr",
      "PesoProducto": 250,
      "FechaVencimiento": "2026-02-15T00:00:00Z",
      "estado": "Activo",
      "FechaIngreso": "19-02-2026 20:31",
      "DiasRetiro": 10,
      "flag": false
    }
  },
  {
    "_id": "699774bf6856cbad7b2e081f",
    "mbData": {
      "creationDate": "2026-02-26T04:34:31.542Z",
      "createdBy": null,
      "creationMethod": null,
      "modDate": "2026-02-26T04:34:31.542Z",
      "modBy": null,
      "modMethod": null
    },
    "customerData": {
      "LoteProducto": "TEST-P04",
      "NombreProducto": "arroz largo",
      "MarcaProducto": "Carozzi",
      "CategoriaProducto": "Productos de Larga Duración",
      "Cantidad": 20,
      "UnidadMedida": "Gr",
      "PesoProducto": 250,
      "FechaVencimiento": "2026-04-30T00:00:00Z",
      "estado": "Activo",
      "FechaIngreso": "19-02-2026 20:32",
      "DiasRetiro": 30,
      "flag": false
    }
  },
  {
    "_id": "6997752325890833cf5ad24d",
    "mbData": {
      "creationDate": "2026-02-26T04:34:31.542Z",
      "createdBy": null,
      "creationMethod": null,
      "modDate": "2026-02-26T04:34:31.542Z",
      "modBy": null,
      "modMethod": null
    },
    "customerData": {
      "LoteProducto": "TEST-P05",
      "NombreProducto": "leche entera",
      "MarcaProducto": "Surlat",
      "CategoriaProducto": "Productos Ultra Perecederos ",
      "Cantidad": 30,
      "UnidadMedida": "L",
      "PesoProducto": 1,
      "FechaVencimiento": "2026-02-23T00:00:00Z",
      "estado": "Activo",
      "FechaIngreso": "19-02-2026 20:34",
      "DiasRetiro": 5,
      "flag": false
    }
  },
  {
    "_id": "6998db506856cbad7b2e18de",
    "mbData": {
      "creationDate": "2026-02-26T04:34:31.542Z",
      "createdBy": null,
      "creationMethod": null,
      "modDate": "2026-02-26T04:34:31.542Z",
      "modBy": null,
      "modMethod": null
    },
    "customerData": {
      "LoteProducto": "TEST-P06",
      "NombreProducto": "Manjar",
      "MarcaProducto": "Nestle",
      "CategoriaProducto": "Productos Perecederos ",
      "Cantidad": 12,
      "UnidadMedida": "Gr",
      "PesoProducto": 500,
      "FechaVencimiento": "2026-06-06T00:00:00Z",
      "estado": "Activo",
      "FechaIngreso": "20-02-2026 22:02",
      "DiasRetiro": 10,
      "flag": false
    }
  },
  {
    "_id": "6998db806856cbad7b2e18e0",
    "mbData": {
      "creationDate": "2026-02-26T04:34:31.542Z",
      "createdBy": null,
      "creationMethod": null,
      "modDate": "2026-02-26T04:34:31.542Z",
      "modBy": null,
      "modMethod": null
    },
    "customerData": {
      "LoteProducto": "\tTEST-P07",
      "NombreProducto": "Cloro",
      "MarcaProducto": "Clorox",
      "CategoriaProducto": "Productos Especiales ",
      "Cantidad": 30,
      "UnidadMedida": "L",
      "PesoProducto": 1,
      "FechaVencimiento": "2026-08-07T00:00:00Z",
      "estado": "Activo",
      "FechaIngreso": "20-02-2026 22:03",
      "DiasRetiro": 60,
      "flag": false
    }
  },
  {
    "_id": "6998dbb969a908ef42333157",
    "mbData": {
      "creationDate": "2026-02-26T04:34:31.542Z",
      "createdBy": null,
      "creationMethod": null,
      "modDate": "2026-02-26T04:34:31.542Z",
      "modBy": null,
      "modMethod": null
    },
    "customerData": {
      "LoteProducto": "TEST-P08",
      "NombreProducto": "Bebida coca cola",
      "MarcaProducto": "Coca-Cola",
      "CategoriaProducto": "Productos de Larga Duración",
      "Cantidad": 20,
      "UnidadMedida": "L",
      "PesoProducto": 3,
      "FechaVencimiento": "2026-08-23T00:00:00Z",
      "estado": "Activo",
      "FechaIngreso": "20-02-2026 22:04",
      "DiasRetiro": 30,
      "flag": false
    }
  },
  {
    "_id": "6998dc5325890833cf5ae34a",
    "mbData": {
      "creationDate": "2026-02-26T04:34:31.542Z",
      "createdBy": null,
      "creationMethod": null,
      "modDate": "2026-02-26T04:34:31.542Z",
      "modBy": null,
      "modMethod": null
    },
    "customerData": {
      "LoteProducto": "TEST-P09",
      "NombreProducto": "Pan",
      "MarcaProducto": "Ianza",
      "CategoriaProducto": "Productos Ultra Perecederos ",
      "Cantidad": 4,
      "UnidadMedida": "Kg",
      "PesoProducto": 3,
      "FechaVencimiento": "2026-02-22T00:00:00Z",
      "estado": "Activo",
      "FechaIngreso": "20-02-2026 22:06",
      "DiasRetiro": 5,
      "flag": false
    }
  },
  {
    "_id": "699d2cfd6856cbad7b2e4ae9",
    "mbData": {
      "creationDate": "2026-02-26T04:34:31.542Z",
      "createdBy": null,
      "creationMethod": null,
      "modDate": "2026-02-26T04:34:31.542Z",
      "modBy": null,
      "modMethod": null
    },
    "customerData": {
      "LoteProducto": "TEST-P10",
      "NombreProducto": "Chocolate trencito",
      "MarcaProducto": "Nestle",
      "CategoriaProducto": "Productos Ultra Perecederos ",
      "Cantidad": 10,
      "UnidadMedida": "Gr",
      "PesoProducto": 250,
      "FechaVencimiento": "2026-02-28T00:00:00Z",
      "estado": "Activo",
      "FechaIngreso": "24-02-2026 04:40",
      "DiasRetiro": 5,
      "flag": false
    }
  },
  {
    "_id": "699fcca46856cbad7b2e6c0b",
    "customerData": {
      "LoteProducto": "TEST-P12",
      "NombreProducto": "margarina",
      "MarcaProducto": "Calo",
      "CategoriaProducto": "Productos Ultra Perecederos ",
      "Cantidad": 13,
      "UnidadMedida": "Gr",
      "PesoProducto": 250,
      "FechaVencimiento": "2026-03-03T00:00:00Z",
      "estado": "Activo",
      "FechaIngreso": "26-02-2026 04:25",
      "DiasRetiro": 5,
      "flag": false
    },
    "mbData": {
      "creationDate": "2026-02-26T04:34:31.542Z",
      "createdBy": null,
      "creationMethod": null,
      "modDate": "2026-02-26T06:00:35.000Z",
      "modBy": "bar.riffo@duocuc.cl",
      "modMethod": "A10_tll_00189"
    }
  },
  {
    "_id": "699fcce025890833cf5b34a4",
    "customerData": {
      "LoteProducto": "TEST-P13",
      "NombreProducto": "agua",
      "MarcaProducto": "Bresler",
      "CategoriaProducto": "Productos Perecederos ",
      "Cantidad": 23,
      "UnidadMedida": "L",
      "PesoProducto": 3,
      "FechaVencimiento": "2026-03-08T00:00:00Z",
      "estado": "Activo",
      "FechaIngreso": "26-02-2026 04:26",
      "DiasRetiro": 10,
      "flag": false
    },
    "mbData": {
      "creationDate": "2026-02-26T04:34:31.542Z",
      "createdBy": null,
      "creationMethod": null,
      "modDate": "2026-02-26T06:02:37.000Z",
      "modBy": "bar.riffo@duocuc.cl",
      "modMethod": "A10_tll_00189"
    }
  }
  ]
  
  const hoyISO = new Date().toISOString()
  
  function formatDate(date) {
    const d = String(date.getDate()).padStart(2, '0')
    const m = String(date.getMonth() + 1).padStart(2, '0')
    const y = date.getFullYear()
    return `${d}-${m}-${y}`
  }
  
  function calcularProductos(productos, hoyISO) {
    const hoy = new Date(hoyISO)
    const porVencer = []
    const vencidos = []
  
    productos.forEach(producto => {
      const fechaVencimiento = new Date(producto.customerData.FechaVencimiento)
      const diasRetiro = producto.customerData.DiasRetiro || 0
      const diasRestantes = Math.floor((fechaVencimiento - hoy) / (1000 * 60 * 60 * 24))
      const fechaRetiro = new Date(fechaVencimiento)
      fechaRetiro.setDate(fechaRetiro.getDate() - diasRetiro)
  
      let estado
      if (diasRestantes < 0) {
        estado = 'VENCIDO'
      } else if (hoy >= fechaRetiro) {
        estado = 'CRITICO'
      } else {
        estado = 'NORMAL'
      }
  
      const productoCalculado = {
        ...producto,
        calculado: {
          diasRestantes,
          fechaRetiro: formatDate(fechaRetiro),
          fechaVencimientoFormateada: formatDate(fechaVencimiento),
          estado
        }
      }
  
      // Solo incluir los que YA entraron en ventana de retiro o ya vencieron
      if (diasRestantes < 0) {
        vencidos.push(productoCalculado)
      } else if (hoy >= fechaRetiro) {
        porVencer.push(productoCalculado)
      }
      // NORMAL no se incluye, aún no hay que avisarlo
    })
  
    return { porVencer, vencidos }
  }
  
  console.log('=== MOCK TEST - Productos a notificar ===')
  console.log(`Hoy: ${hoyISO}\n`)
  
  const { porVencer, vencidos } = calcularProductos(productos, hoyISO)
  
  console.log(`--- EN VENTANA DE RETIRO (${porVencer.length}) ---`)
  if (porVencer.length === 0) {
    console.log('Ninguno\n')
  } else {
    porVencer.forEach(p => {
      console.log(`[${p.calculado.estado}] ${p.customerData.LoteProducto} - ${p.customerData.NombreProducto}`)
      console.log(`  Vence: ${p.calculado.fechaVencimientoFormateada} | Días restantes: ${p.calculado.diasRestantes} | Retiro desde: ${p.calculado.fechaRetiro}\n`)
    })
  }
  
  console.log(`--- VENCIDOS (${vencidos.length}) ---`)
  if (vencidos.length === 0) {
    console.log('Ninguno\n')
  } else {
    vencidos.forEach(p => {
      console.log(`[VENCIDO] ${p.customerData.LoteProducto} - ${p.customerData.NombreProducto}`)
      console.log(`  Venció: ${p.calculado.fechaVencimientoFormateada} | Hace: ${Math.abs(p.calculado.diasRestantes)} días\n`)
    })
  }

  const lotesVencidos = vencidos.map(p => p.customerData.LoteProducto)
const lotesCriticos = porVencer.map(p => p.customerData.LoteProducto)

// Generar operations para bulkwrite2
const operationsVencidos = lotesVencidos.map(lote => ({
  updateOne: {
    filter: `{ "customerData.LoteProducto": "${lote}" }`,
    update: `{"$set": {"customerData.estado": "Vencido"}}`,
    upsert: false
  }
}))

const operationsCriticos = lotesCriticos.map(lote => ({
  updateOne: {
    filter: `{ "customerData.LoteProducto": "${lote}" }`,
    update: `{"$set": {"customerData.estado": "Critico"}}`,
    upsert: false
  }
}))

const operationsTotal = [...operationsVencidos, ...operationsCriticos]

console.log('--- LOTES VENCIDOS ---')
console.log(lotesVencidos)

console.log('--- LOTES CRITICOS ---')
console.log(lotesCriticos)

console.log('\n--- OPERATIONS BULKWRITE (JSON listo para inyectar) ---')
console.log(JSON.stringify(operationsTotal, null, 2))